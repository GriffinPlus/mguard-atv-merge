# mguard-config-tool

[![Build Status](https://dev.azure.com/griffinplus/mGuard-Config-Tool/_apis/build/status/mguard-config-tool?branchName=master)](https://dev.azure.com/griffinplus/mGuard-Config-Tool/_build/latest?definitionId=16&branchName=master)
[![Release](https://img.shields.io/github/release/griffinplus/mguard-config-tool.svg?logo=github)](https://github.com/GriffinPlus/mguard-config-tool/releases)

-----

## Status

**This project is under active development and should not be used in production, yet.**

-----

## Overview and Motivation

The *mGuard* security router series is a family of firewall/router devices that is produced by the PHOENIX CONTACT
Cyber Security AG, a member of the [PHOENIX CONTACT group](https://www.phoenixcontact.com/). An *mGuard* in connection
with the [mGuard Secure Cloud](https://us.cloud.mguard.com/) can be used for remote servicing machines in the field
via IPSec-VPN.

Setting up an *mGuard* in the *mGuard Secure Cloud* generates a configuration file containing everything that is needed
to connect to the cloud. The configuration file can then be loaded into the *mGuard* to set it up properly. As a
configuration file is a snapshot of all settings, loading a configuration file replaces existing settings in the
*mGuard*. Therefore it is not possible to have custom settings along with the configuration file generated by the
cloud. A tool that is able to merge two configurations into one would be handy. This is where the *mGuard-Config-Tool*
comes into play.

The *mGuard-Config-Tool* aims to ease handling *mGuard* configuration files. It's main features are:

- Support for ATV files and (unencrypted) ECS containers
- Tasks
  - User Management: Add users and set/verify passwords
  - Conditioning: Condition a configuration and convert formats (ATV <=> ECS)
  - Merging: Merge two configurations into one

## Releases

*mGuard-Config-Tool* is written in GO which makes it highly portable.

[Downloads](https://github.com/GriffinPlus/mguard-config-tool/releases) are provided for the following combinations of
popular target operating systems and platforms:

- Linux
  - Intel x86 Platform (`386`)
  - Intel x64 Platform (`amd64`)
  - ARM 32-bit Platform (`arm`)
  - ARM 64-bit Platform (`arm64`)
- Windows
  - Intel x86 Platform (`386`)
  - Intel x64 Platform (`amd64`)

If any other target operating system and/or platform is needed and the combination is supported by GO, please open an
issue and we'll add support for it.

## Usage

The *mGuard-Config-Tool* is a console application that uses subcommands to run different tasks. The application writes
log messages to *stderr*, so it's easy to pipe them into a log file or discard them entirely. The *stdout* channel is
used for emitting content only.

### Subcommand: user

The `user` subcommand provides access to the user management. All operations run on ECS files only, but support an
implicit conversion if an ATV file is specified. ATV files do not contain information about user accounts and
passwords. By default the ECS container to work on is expected to be passed via *stdin* to ease scripting without
generating temporary files. The output of these operations is an ECS container that is written to *stdout*.
Optionally input and output can be regular files as well by specifying `--ecs-in` and `--ecs-out` appropriately.

```
user - Add user and set/verify user passwords (ECS containers only).

  Usage:
        user [add|password]

  Subcommands:
    add        Add a user.
    password   Set or verify the password of a user.

  Flags:
       --version   Displays the program version string.
    -h --help      Displays help with available flag, subcommand, and positional value parameters.
       --verbose   Include additional messages that might help when problems occur.
```

The subcommand `user add` allows to add new users:

```
add - Add a user.

  Usage:
        add [username] [password]

  Positional Variables:
        username   Login name of the user. (Required)
        password   Password of the user. (Required)

  Flags:
       --version   Displays the program version string.
    -h --help      Displays help with available flag, subcommand, and positional value parameters.
       --ecs-in    The ECS container (instead of stdin).
       --ecs-out   File receiving the updated ECS container (instead of stdout).
       --verbose   Include additional messages that might help when problems occur.
```

The subcommand `user password set` sets the password of a user.

```
set - Set the password a user (ECS containers only).

  Usage:
        set [username] [password]

  Positional Variables:
        username   Login name of the user. (Required)
        password   Password of the user. (Required)

  Flags:
       --version   Displays the program version string.
    -h --help      Displays help with available flag, subcommand, and positional value parameters.
       --ecs-in    The ECS container (instead of stdin).
       --ecs-out   File receiving the updated ECS container (instead of stdout).
       --verbose   Include additional messages that might help when problems occur.
```

The subcommand `user password verify` verifys the password of a user. Depending on the outcome of the verification the
exit code can be one of the following:

- 0 : The specified password is correct.
- 1 : The specified password is not correct.
- any other : An error occurred.

```
verify - Verify the password of a user (ECS containers only).

  Usage:
        verify [username] [password]

  Positional Variables:
        username   Login name of the user. (Required)
        password   Password of the user. (Required)

  Flags:
       --version   Displays the program version string.
    -h --help      Displays help with available flag, subcommand, and positional value parameters.
       --ecs-in    The ECS container (instead of stdin).
       --verbose   Include additional messages that might help when problems occur.
```

### Subcommand: condition

The `condition` subcommand provides access to conditioning and conversion. *Conditioning* takes a configuration file,
parses the configuration and writes the configuration properly formatted. *Conversion* actually conditions a
configuration and writes it using a different format (ATV or ECS). This way an ATV file that was originally created for
use with the mGuard web interface can be converted to an ECS file that can be used to configure an mGuard via SDCard
and vice versa.

By default the ECS container to work on is expected to be passed via *stdin* to ease scripting without generating
temporary files. The output of the operation is an ECS container that is written to *stdout*. Optionally input and
output can be regular files as well by specifying `--ecs-in`, `--ecs-out` and `--atv-out` appropriately.

If an ATV file is passed in and an ECS container is written the conditioned ATV file is stored in the ECS container and
the missing parts in the ECS container are initialized with defaults. The defaults are the same a new mGuard comes with.
If an ECS container is passwd in and an ATV file is written, the configuration stored in the ECS container is simply
extracted and saved as an ATV file.

```
condition - Condition and/or convert a mGuard configuration file

  Flags:
       --version   Displays the program version string.
    -h --help      Displays help with available flag, subcommand, and positional value parameters.
       --in        File containing the mGuard configuration to condition (ATV format or ECS container)
       --atv-out   File receiving the conditioned configuration (ATV format)
       --ecs-out   File receiving the conditioned configuration (ECS container, instead of stdout)
       --verbose   Include additional messages that might help when problems occur.
```

### Subcommand: merge

The `merge` subcommand merges two configuration files into one. The first specified file is taken as the base for the
result, then the configuration stored in the second file "stacked" upon the first configuration. Simple values and
complex values are overwritten and table values (lists) are merged by appending all rows in a table in the second
configuration to the corresponding table in the first configuration. If the first file is an ATV file, it is implicitly
converted to an ECS file first. Therefore the resulting ECS container contains default settings for all elements except
the encorporated mGuard configuration (`/aca/cfg`).

By default the output of the operation is an ECS container that is written to *stdout*. The output can be written to
a regular file as well by specifying `--ecs-out` and `--atv-out` appropriately.

**STATUS: not working, yet - the result is the first file specified**

```
merge - Merge two mGuard configuration files into one

  Usage:
	merge [1st-file] [2nd-file]

  Positional Variables: 
	1st-file   First configuration file to merge (Required)
	2nd-file   Second configuration file to merge (Required)

  Flags: 
       --version   Displays the program version string.
    -h --help      Displays help with available flag, subcommand, and positional value parameters.
       --atv-out   File receiving the merged configuration (ATV format)
       --ecs-out   File receiving the merged configuration (ECS container, instead of stdout)
       --verbose   Include additional messages that might help when problems occur.
```

## Known Limitations

- Comments: Reading a configuration file discards comments, so a written configuration file does not contain any comments.

## Issues and Contributions

As *mGuard-Config-Tool* is **not** a project of PHOENIX CONTACT, please don't request help for it there!

If you encounter problems using *mGuard-Config-Tool*, please file an [issue](https://github.com/GriffinPlus/mguard-config-tool/issues).

If you have an idea on how to improve *mGuard-Config-Tool*, please also file an [issue](https://github.com/GriffinPlus/mguard-config-tool/issues).
Pull requests are also very appreciated. In case of major changes, please open an issue before to discuss the changes.
This helps to coordinate development and avoids wasting time.
